{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oferta Laboral</title>
  <link rel="stylesheet" href="{% static 'css/registro_empresa.css' %}" />
</head>
<body>
  <div class="form-container">
    <a href="{% url 'trabajos:index_trabajo' %}" class="btn-volver">&larr; Volver</a>

    <h2>ðŸ’¼ Oferta Laboral</h2>
    <p>Detalles del puesto disponible para primer trabajo</p>

    <form enctype="multipart/form-data" method="POST" onsubmit="return validarUbicacion();">
      {% csrf_token %}
      {{ form.non_field_errors }}

      {{ form.titulo_puesto.label_tag }}
      {{ form.titulo_puesto }}

      {{ form.rango_salarial.label_tag }}
      {{ form.rango_salarial }}

      {{ form.experiencia_requerida.label_tag }}
      {{ form.experiencia_requerida }}

      {{ form.modalidad_trabajo.label_tag }}
      {{ form.modalidad_trabajo }}

      {{ form.descripcion_puesto.label_tag }}
      {{ form.descripcion_puesto }}

      {{ form.requisitos_calificaciones.label_tag }}
      {{ form.requisitos_calificaciones }}

      {{ form.beneficios_compensaciones.label_tag }}
      {{ form.beneficios_compensaciones }}

      {{ form.fecha_limite.label_tag }}
      {{ form.fecha_limite }}

      {{ form.numero_postulantes.label_tag }}
      {{ form.numero_postulantes }}

      <label for="id_departamento">Departamento *</label>
      <select id="id_departamento" name="id_departamento" required>
        <option value="">Seleccione</option>
        {% for departamento in departamentos %}
        <option value="{{ departamento.id_departamento }}">{{ departamento.nombre }}</option>
        {% endfor %}
      </select>

      <label for="id_provincia">Provincia</label>
      <select id="id_provincia" name="id_provincia">
        <option value="">Seleccione</option>
      </select>

      <label for="id_distrito">Distrito</label>
      <select id="id_distrito" name="id_distrito">
        <option value="">Seleccione</option>
      </select>

      <label for="id_comunidad">Comunidad</label>
      <select id="id_comunidad" name="id_comunidad">
        <option value="">Seleccione</option>
      </select>

      {{ form.direccion_detalle.label_tag }}
      {{ form.direccion_detalle }}

      {{ form.foto.label_tag }}
      {{ form.foto }}
      <img id="preview" class="image-preview" style="display:none" />

      <div class="form-buttons">
        <button type="button" class="cancel" onclick="window.location.href='{% url 'trabajos:index_trabajo' %}'">Cancelar</button>
        <button type="submit" class="submit">Publicar Oferta</button>
      </div>
    </form>
  </div>

  <script>
    function validarUbicacion() {
      const departamento = document.getElementById('id_departamento').value;
      const provincia = document.getElementById('id_provincia').value;
      const distrito = document.getElementById('id_distrito').value;
      const comunidad = document.getElementById('id_comunidad').value;
      if (!departamento && !provincia && !distrito && !comunidad) {
        alert("Debe completar al menos uno de los campos de ubicaciÃ³n.");
        return false;
      }
      return true;
    }

    function previewImage(event) {
      const preview = document.getElementById('preview');
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = 'none';
        preview.src = '';
      }
    }

    document.getElementById('id_departamento').addEventListener('change', function() {
      const deptId = this.value;
      fetch(`/trabajos/ajax/provincias/?id_departamento=${deptId}`)
        .then(res => res.json())
        .then(data => {
          const provinciaSelect = document.getElementById('id_provincia');
          provinciaSelect.innerHTML = '<option value="">Seleccione</option>';
          data.forEach(p => provinciaSelect.innerHTML += `<option value="${p.id_provincia}">${p.nombre}</option>`);
        });
    });

    document.getElementById('id_provincia').addEventListener('change', function() {
      const provId = this.value;
      fetch(`/trabajos/ajax/distritos/?id_provincia=${provId}`)
        .then(res => res.json())
        .then(data => {
          const distritoSelect = document.getElementById('id_distrito');
          distritoSelect.innerHTML = '<option value="">Seleccione</option>';
          data.forEach(p => distritoSelect.innerHTML += `<option value="${p.id_distrito}">${p.nombre}</option>`);
        });
    });

    document.getElementById('id_distrito').addEventListener('change', function() {
      const distId = this.value;
      fetch(`/trabajos/ajax/comunidades/?id_distrito=${distId}`)
        .then(res => res.json())
        .then(data => {
          const comunidadSelect = document.getElementById('id_comunidad');
          comunidadSelect.innerHTML = '<option value="">Seleccione</option>';
          data.forEach(p => comunidadSelect.innerHTML += `<option value="${p.id_comunidad}">${p.nombre}</option>`);
        });
    });

    // Activar preview si ya existe input con ID
    const fotoInput = document.getElementById('id_foto');
    if (fotoInput) {
      fotoInput.addEventListener('change', previewImage);
    }
  </script>
</body>
</html>
